{% extends 'base.html.twig' %}

{% block title %}Verify your email{% endblock %}

{% block body %}

    <h1>Confirm your email</h1>

    <p id="response">

    </p>

    <p>
        Email not received? Click <a href="#" id="resend">here</a> to resend the verification link.
    </p>

    <script>

        var current = 0;
        var lastTime = 0;

        $(document).ready(function() {
            $('#resend').on("click", function () {
                current = new Date().getTime();
                if ((current - lastTime) >= 6000) {
                    resendEmailVerification();
                    lastTime = new Date().getTime();
                }
                console.log(current - lastTime)

            })
        });

        var timesBad = 0;

        function resendEmailVerification() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);

                        if (response.can) {
                            $('#response').text("New verification link has been sent to your email");
                            timesBad = 0;
                        } else {
                            timesBad++;
                            $('#response').text("Please wait up to one minute before sending the verification link again" + (timesBad >= 2 ? " #" + timesBad : ""));
                        }
                    } else {
                        console.error("Błąd: " + xhr.status);
                    }
                }
            };

            xhr.open("GET", "{{ path('app_resend_email') }}", true);
            xhr.send();
        }

    </script>

{% endblock %}

{% block endjs %}

{% endblock %}